pkgname=glib
pkgver=2.30.2
_mver=2.30
pkgrel=1
pkgdesc="Common C routines used by GTK+ and other libs"
url="http://www.gtk.org/"
arch=(i686 x86_64)
license=('LGPL')
depends=('zlib' 'libffi')
makedepends=('zlib' 'libffi' 'gettext')
options=('!libtool' '!docs')
build() {
  cd "${srcdir}/${pkgname}-${pkgver}"
  sed 's/^\(.*\SUBDIRS .*\=.*\)po docs\(.*\)$/\1\2/' -i $(find . -name Makefile.am -o -name Makefile.in)
  sed 's/^\(.*\SUBDIRS .*\=.*\)tests\(.*\)$/\1\2/' -i $(find . -name Makefile.am -o -name Makefile.in)
  sed -i 's:^tests\/.*$::' configure.ac
  sed -i 's:^docs\/.*$::' configure.ac
  Patch glib-2.30.1-external-gdbus-codegen.patch
  Patch glib-2.30.2-machine-id.patch
  ln -sfn /bin/true py-compile
  AT_M4DIR="${srcdir}/${pkgname}-${pkgver}" autoreconf -v
  export DBUS1_CFLAGS="-I/usr/include/dbus-1.0 -I/usr/lib/dbus-1.0/include"
  export DBUS1_LIBS="-ldbus-1"
  export LIBFFI_CFLAGS="-I$(echo /usr/lib/libffi-*/include)"
  export LIBFFI_LIBS="-lffi"
  sed -i 's:^GTK_DOC_CHECK.*$::' configure
  ./configure --prefix=/usr \
              --build=${CBUILD} \
              --host=${CHOST} \
              --mandir=/usr/share/man \
              --sysconfdir=/etc \
              --enable-regex \
              --with-pcre=internal \
              --with-threads=posix \
              --disable-dtrace \
              --disable-systemtap \
              --disable-dependency-tracking \
              --enable-debug=yes \
              --disable-selinux \
              --enable-gtk-doc-html=no \
              --disable-fam
  make
}

package() {
  cd "${srcdir}/${pkgname}-${pkgver}"
  make DESTDIR="${pkgdir}" install
  rm -rf "${pkgdir}/usr/share/gdb/" "${pkgdir}/usr/share/glib-2.0/gdb/"
  for _i in "${pkgdir}/etc/bash_completion.d/"*; do
    chmod -x "${_i}"
  done
}

source=(http://ftp.gnome.org/pub/GNOME/sources/${pkgname}/${_mver}/${pkgname}-${pkgver}.tar.xz
        glib-2.30.2-machine-id.patch
        glib-2.30.1-external-gdbus-codegen.patch)
sha256sums=('f0e91e6333321ddb48fa12b5c66f56c3d5f05325748c66dd2e9016c278ff8e82'
            'c8341c9025bfaa728cb69ad6ee47040aba2309046050dbb357def72cf90413f4'
            '45daf662034806d2858f1b2b43185e6891e9d395acd3bbfb7a81a15541b49078')
