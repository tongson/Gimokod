# Based upon the PKGBUILD from Arch Linux.
# Patches from Gentoo, Openwall, Mandriva
pkgname=glibc
pkgver=2.15
pkgrel=1
pkgdesc="GNU C Library"
arch=('x86_64')
url="http://www.gnu.org/software/libc"
license=('GPL' 'LGPL')
groups=('base')
install=glibc.install
makedepends=('gcc' 'gawk' 'tzdata' 'linux-headers')
options=('!makeflags' '!strip')
noextract=('crypt_blowfish-1.2.tar.gz')

build() {
  cd "${srcdir}/${pkgname}-${pkgver}"

  sed -i '11s:de_DE.UTF-8:en_US.UTF-8:' posix/bug-regex32.c # no .de here
  sed -i '229s:$(objpfx)annexc.out::' posix/Makefile # bogus
  sed -i '2s:tests += tst-writev::' sysdeps/wordsize-64/Makefile # Debian:629862
  sed -i '48s:tst-mqueue5::' rt/Makefile # sourceware/ml/libc-alpha/2010-09/msg00030.html
  sed -i '50s:tst-cpuclock2::' rt/Makefile # bogus
  sed -i '35s:nss3:nss:' scripts/check-local-headers.sh # correct dir
  Patch glibc-2.15-no-po-manual.patch

  # Gentoo
  Patch 0020_all_glibc-tweak-rfc1918-lookup.patch
  Patch 0068_all_glibc-2.14-glibc-revert-fseek-on-fclose.patch
  Patch 1010_all_glibc-queue-header-updates.patch
  Patch 1055_all_glibc-resolv-dynamic.patch
  Patch 1070_all_glibc-fadvise64_64.patch
  Patch 1090_all_glibc-2.3.6-fix-pr631.patch
  Patch 1160_all_glibc-2.8-nscd-one-fork.patch
  Patch 3020_all_glibc-tests-sandbox-libdl-paths.patch

  # OpenSUSE
  Patch cycle-detection.patch

  # Openwall patches http://www.openwall.com/crypt/
  install -pm644 ../crypt_freesec.{c,h} crypt/
  Patch glibc-2.14-owl-crypt.patch
  tar -xf ../crypt_blowfish-1.2.tar.gz
  mv crypt/{crypt.h,gnu-crypt.h}
  cp -p crypt_blowfish-1.2/*.{c,h,S} crypt/
  Patch glibc-2.14-owl-crypt_freesec.patch

  # Mandriva
  Patch glibc-2.14-owl-crypt-increase_BF_FRAME.patch
  Patch glibc-2.14-owl-wrapper-sha.patch

  # timezone data is in separate package (tzdata)
  # http://sourceware.org/git/?p=glibc.git;a=commit;h=482ff4da
  patch -p1 -i ${srcdir}/glibc-2.15-do-not-install-timezone-files.patch
  # http://sourceware.org/git/?p=glibc.git;a=commit;h=a458e7fe
  patch -p1 -i ${srcdir}/glibc-2.15-do-not-install-timezone-files-2.patch

  # undefine __i686
  # http://sourceware.org/glibc/wiki/Release/2.15#Build_Failures
  patch -p1 -i ${srcdir}/glibc-__i686.patch

  # http://www.exploit-db.com/exploits/15274/
  # http://sourceware.org/git/?p=glibc.git;a=patch;h=d14e6b09  (fedora branch)
  patch -p1 -i ${srcdir}/glibc-2.12.2-ignore-origin-of-privileged-program.patch

  # http://sourceware.org/git/?p=glibc.git;a=commitdiff;h=675155e9  (fedora branch)
  # http://sourceware.org/ml/libc-alpha/2011-06/msg00006.html
  patch -p1 -i ${srcdir}/glibc-2.14-libdl-crash.patch

  # re-export RPC interface until libtirpc is ready as a replacement
  # http://sourceware.org/git/?p=glibc.git;a=commitdiff;h=acee4873  (fedora branch)
  patch -p1 -i ${srcdir}/glibc-2.14-reexport-rpc-interface.patch
  # http://sourceware.org/git/?p=glibc.git;a=commitdiff;h=bdd816a3  (fedora branch)
  patch -p1 -i ${srcdir}/glibc-2.14-reinstall-nis-rpc-headers.patch

  # fix res_query assertion
  # http://sourceware.org/bugzilla/show_bug.cgi?id=13013
  patch -p1 -i ${srcdir}/glibc-2.15-fix-res_query-assert.patch

  # propriety nvidia crash - https://bugzilla.redhat.com/show_bug.cgi?id=737223 
  # http://sourceware.org/git/?p=glibc.git;a=commitdiff;h=0c95ab64  (fedora branch)
  patch -p1 -i ${srcdir}/glibc-2.15-lddebug-scopes.patch

  # revert commit c5a0802a - causes various hangs
  # https://bugzilla.redhat.com/show_bug.cgi?id=769421
  # Note: fedora may have actual fix (not submitted upstream yet...)
  # http://pkgs.fedoraproject.org/gitweb/?p=glibc.git;a=blob_plain;f=glibc-rh552960-2.patch
  patch -p1 -i ${srcdir}/glibc-2.15-revert-c5a0802a.patch

  # fix realloc usage in vfscanf
  # http://sourceware.org/git/?p=glibc.git;a=commit;h=20b38e03
  patch -p1 -i ${srcdir}/glibc-2.15-scanf.patch

  # fix ifunc relocations
  # http://sourceware.org/git/?p=glibc.git;a=commit;h=6ee65ed6
  patch -p1 -i ${srcdir}/glibc-2.15-ifunc.patch

  # fix AVX detection
  # http://sourceware.org/git/?p=glibc.git;a=commit;h=afc5ed09
  # http://sourceware.org/git/?p=glibc.git;a=commit;h=08cf777f
  patch -p1 -i ${srcdir}/glibc-2.15-avx.patch
  # and "fix" strcasecmp
  patch -p1 -i ${srcdir}/glibc-2.15-strcasecmp-disable-avx.patch

  # fix GB18030 charmap
  # http://sourceware.org/bugzilla/show_bug.cgi?id=11837
  # http://sourceware.org/git/?p=glibc.git;a=commit;h=2a57bd79  (fedora branch)
  # http://sourceware.org/git/?p=glibc.git;a=commit;h=3d828a61  (fedora branch)
  patch -p1 -i ${srcdir}/glibc-2.15-gb18030.patch

  # fix crash in __nscd_get_mapping if nscd not running
  # http://sourceware.org/bugzilla/show_bug.cgi?id=13594 (potential "fix" in comment)
  # reverts commit 3a2c0242 and other necessary following changes...
  patch -p1 -i ${srcdir}/glibc-2.15-revert-netlink-cache.patch

  # handle ARENA_TEST correctly
  # http://sourceware.org/git/?p=glibc.git;a=commit;h=41b81892
  patch -p1 -i ${srcdir}/glibc-2.15-arena.patch

  # Do not cache negative results in nscd if these are transient
  # http://sourceware.org/git/?p=glibc.git;a=commit;h=3e1aa84e
  patch -p1 -i ${srcdir}/glibc-2.15-negative-result-cache.patch

  # strcasecmp_l, strncasecmp_l act as strcmp for multiarch x86
  # http://sourceware.org/git/?p=glibc.git;a=commit;h=0bab47b6
  patch -p1 -i ${srcdir}/glibc-2.15-multiarch-x86-strcmp.patch

  # always set l_used for vDSO.
  # http://sourceware.org/git/?p=glibc.git;a=commit;h=1f393a11
  patch -p1 -i ${srcdir}/glibc-2.15-vdso.patch

  # fix x86 PLT slot usage for feraiseexcept
  # http://sourceware.org/git/?p=glibc.git;a=commit;h=7c35ffed
  patch -p1 -i ${srcdir}/glibc-2.15-feraiseexcept-plt.patch

  # vfprintf nargs overflow - CVE-2012-0864
  # http://sourceware.org/git/?p=glibc.git;a=commit;h=7c1f4834
  patch -p1 -i ${srcdir}/glibc-2.15-vfprintf-nargs.patch

  # avoid out ouf bounds read in __libc_res_nquerydomain
  # http://sourceware.org/git/?p=glibc.git;a=commit;h=8fdceb2e
  patch -p1 -i ${srcdir}/glibc-2.15-__libc_res_nquerydomain-out-of-bounds.patch

  # make fmtmsg function thread-safe
  # http://sourceware.org/git/?p=glibc.git;a=commit;h=7724defc
  patch -p1 -i ${srcdir}/glibc-2.15-fmtmsg-locking.patch

  # use non-signaling floating-point comparisons in math functions
  # http://sourceware.org/git/?p=glibc.git;a=commit;h=92221550
  patch -p1 -i ${srcdir}/glibc-2.15-non-signalling-comparisons.patch

  # fix rintf rounding.
  # http://sourceware.org/git/?p=glibc.git;a=commit;h=fe45ce09
  patch -p1 -i ${srcdir}/glibc-2.15-rintf-rounding.patch

  # fix nearbyintf rounding
  # http://sourceware.org/git/?p=glibc.git;a=commit;h=6cbeae47
  patch -p1 -i ${srcdir}/glibc-2.15-nearbyintf-rounding.patch

  # fix variable scope issue in confstr
  # http://sourceware.org/git/?p=glibc.git;a=commit;h=ac4c54f0
  # http://sourceware.org/git/?p=glibc.git;a=commit;h=d6a403f9
  patch -p1 -i ${srcdir}/glibc-2.15-confstr-local-buffer-extent.patch

  install -dm755 "${pkgdir}"/etc
  touch "${pkgdir}"/etc/ld.so.conf

  cd ${srcdir}
  mkdir glibc-build && cd glibc-build

  echo "slibdir=/usr/lib" >> configparms

  CFLAGS=${CFLAGS/-Os/-O2}
  LDFLAGS=${LDFLAGS/--as-needed,/}
  CFLAGS="${CFLAGS} -DNDEBUG=1"
  LC_CTYPE="en_US.UTF-8"

  "${srcdir}/${pkgname}-${pkgver}/configure" --prefix=/usr \
      --build=${CBUILD} --host=${CHOST} \
      --libdir=/usr/lib --libexecdir=/usr/lib \
      --bindir=/usr/bin --sbindir=/usr/bin \
      --with-headers=/usr/include \
      --enable-add-ons=nptl,libidn \
      --enable-kernel=2.6.37 \
      --with-tls --with-__thread \
      --enable-bind-now --without-gd \
      --without-cvs --disable-profile \
      --disable-multi-arch

  # build libraries with hardening disabled
  echo "build-programs=no" >> configparms
  make

  sed -i "s#=no#=yes#" configparms
  make
}

check() {
  cd ${srcdir}/glibc-build
  export TIMEOUTFACTOR=16
  make -k check || return 0
  # Error 1
}

package() {
  cd "${srcdir}"/glibc-build
  make install_root="${pkgdir}" install

  rm -f "${pkgdir}"/etc/ld.so.{cache,conf}

  install -dm755 "${pkgdir}"/usr/lib/locale
  install -m644 "${srcdir}"/${pkgname}-${pkgver}/nscd/nscd.conf "${pkgdir}"/etc/nscd.conf
  install -m755 "${srcdir}"/locale-gen "${pkgdir}"/usr/bin
  install -m644 "${srcdir}"/${pkgname}-${pkgver}/posix/gai.conf "${pkgdir}"/etc/gai.conf
  echo -e "precedence ::ffff:0:0/96\t100" >> "${pkgdir}"/etc/gai.conf

  sed -i -e 's/^\tserver-user/#\tserver-user/' "${pkgdir}"/etc/nscd.conf
  echo "server-user nscd" >> "${pkgdir}"/etc/nscd.conf

  # create /etc/locale.gen
  install -m644 "${srcdir}"/locale.gen.txt "${pkgdir}"/etc/locale.gen
  sed -i "s|/| |g" "${srcdir}"/${pkgname}-${pkgver}/localedata/SUPPORTED
  sed -i 's|\\| |g' "${srcdir}"/${pkgname}-${pkgver}/localedata/SUPPORTED
  sed -i "s|SUPPORTED-LOCALES=||" "${srcdir}"/${pkgname}-${pkgver}/localedata/SUPPORTED
  cat "${srcdir}"/${pkgname}-${pkgver}/localedata/SUPPORTED >> "${pkgdir}"/etc/locale.gen
  sed -i "s|^|#|g" "${pkgdir}"/etc/locale.gen
  sed -i '/RTLDLIST/s%lib64%lib%' "${pkgdir}"/usr/bin/ldd

  # manually strip files as stripping libpthread-*.so and libthread_db.so
  # with the default $STRIP_SHARED breaks gdb and stripping ld-*.so breaks
  # valgrind on x86_64

  cd "${pkgdir}"
  rm usr/lib/pt_chown
  strip $STRIP_BINARIES sbin/{ldconfig,sln} \
                        usr/bin/{gencat,getconf,getent,iconv,locale} \
                        usr/bin/{localedef,pcprofiledump,rpcgen,sprof} \
                        usr/lib/getconf/* \
                        usr/sbin/{iconvconfig,nscd}

  strip ${STRIP_STATIC} usr/lib/*.a

  strip ${STRIP_SHARED} usr/lib/{libanl,libBrokenLocale,libcidn,libcrypt}-"${pkgver}".so \
                      usr/lib/libnss_{compat,dns,files,hesiod,nis,nisplus}-"${pkgver}".so \
                      usr/lib/{libdl,libm,libnsl,libresolv,librt,libutil}-"${pkgver}".so \
                      usr/lib/{libmemusage,libpcprofile,libSegFault}.so \
                      usr/lib/{audit,gconv}/*.so
  #mv lib/* usr/lib
  mv usr/sbin/nscd usr/bin/gnscd
  mv usr/sbin/iconvconfig usr/bin
  mv sbin/{ldconfig,sln} usr/bin
  #rmdir lib
  rmdir sbin
  rmdir usr/sbin
}
source=(http://ftp.gnu.org/gnu/glibc/glibc-2.15.tar.xz)
sha256sums=('321ec482abdc27b03244f7b345ee22dc431bc55daf9c000a4e7b040fbdbecb50')

source=(${source[@]-}
        0020_all_glibc-tweak-rfc1918-lookup.patch
        0068_all_glibc-2.14-glibc-revert-fseek-on-fclose.patch
        1010_all_glibc-queue-header-updates.patch
        1055_all_glibc-resolv-dynamic.patch
        1070_all_glibc-fadvise64_64.patch
        1090_all_glibc-2.3.6-fix-pr631.patch
        1160_all_glibc-2.8-nscd-one-fork.patch
        3020_all_glibc-tests-sandbox-libdl-paths.patch
        crypt_blowfish-1.2.tar.gz
        crypt_freesec.c
        crypt_freesec.h
        cycle-detection.patch
        glibc-2.12.2-ignore-origin-of-privileged-program.patch
        glibc-2.14-libdl-crash.patch
        glibc-2.14-owl-crypt-increase_BF_FRAME.patch
        glibc-2.14-owl-crypt.patch
        glibc-2.14-owl-crypt_freesec.patch
        glibc-2.14-owl-wrapper-sha.patch
        glibc-2.14-reexport-rpc-interface.patch
        glibc-2.14-reinstall-nis-rpc-headers.patch
        glibc-2.15-__libc_res_nquerydomain-out-of-bounds.patch
        glibc-2.15-arena.patch
        glibc-2.15-avx.patch
        glibc-2.15-confstr-local-buffer-extent.patch
        glibc-2.15-do-not-install-timezone-files-2.patch
        glibc-2.15-do-not-install-timezone-files.patch
        glibc-2.15-feraiseexcept-plt.patch
        glibc-2.15-fix-res_query-assert.patch
        glibc-2.15-fmtmsg-locking.patch
        glibc-2.15-gb18030.patch
        glibc-2.15-ifunc.patch
        glibc-2.15-lddebug-scopes.patch
        glibc-2.15-multiarch-x86-strcmp.patch
        glibc-2.15-nearbyintf-rounding.patch
        glibc-2.15-negative-result-cache.patch
        glibc-2.15-no-po-manual.patch
        glibc-2.15-non-signalling-comparisons.patch
        glibc-2.15-revert-c5a0802a.patch
        glibc-2.15-revert-netlink-cache.patch
        glibc-2.15-rintf-rounding.patch
        glibc-2.15-scanf.patch
        glibc-2.15-strcasecmp-disable-avx.patch
        glibc-2.15-vdso.patch
        glibc-2.15-vfprintf-nargs.patch
        glibc-__i686.patch
        glibc-ld-profile.patch
        locale-gen
        locale.gen.txt)

sha256sums=(${sha256sums[@]-}
            'b14477c710b7d25db20bc907052fce840a2abfae41e7d5abfeb9429115f33bf6'
            'c57077d1ec0e99c41c82142267d58a1704b0953ceff2de868bec0256ec0541f7'
            '598b08b96f68173995725f7868cdb2c9f5b94d85fd0c0ff49475f7f3af7d876d'
            '682184f94377f5a170767f99779e2b654f2b88db640573aaced22b77037948bb'
            'd11926e76fb8828aa00d1d8a0b2cad80fc8ffd0c9a473efa0ac7153cee8aafc0'
            'd6ff88801f46f4e776be1e3b6b0ab3cd258a253b245f21d9b81ee51a6f16e22d'
            '378aaacd1fc008d5d5931ffe0a724569c762771a3871082f7d5d54490241fa19'
            '58a45dc417b9bbdd0406fe0bc2b3fd522b4d29b599e0681b1173a9a589d04890'
            '12a3455700d4795f5a99e6fca54c782688d3785e6525cbfe5129dcc363858e27'
            'e6325d65eb186203af9040513a169a09f5cb049713739a2f58d823380584b6a5'
            '2cfa0c58b6666b26467b001b939f1ed74a5acc10204968c99adb7c597a93dce0'
            '6c132c56c21b03a4075f92de83a6e29fe1f54ca7767ac4418271d300a55ff796'
            'd1dd7360ef510f9d1ae8941c598a035001b632ab98eaf4cb3a67c539f9dac35d'
            '46187f64c2c3037594ec90b98e5dc476585202cca5437fba5af9e509b994119f'
            'c37e6fd20cd0dfb9383724c6c5093c630fbb85af44324e75589fe6c6b594d7f5'
            '8dc5cd915863d947655bfc5a8627f0a61402580124acb5dc914084b7dd3ccfc3'
            '74ceb0d7b1824a0319c5ba130ab933820f9ad90fec4f50030649c615184679a7'
            'a531bd2ce1f63d6e74fdcb6cdfc4eeceaaf0e947855f1dc8371348f139713518'
            '9fdc1600ebaf917e68baf2507788d9f17f69c3d95cb6d479076eba48c14a24a5'
            'f1e6e8fef5545f84905c4acd73307490726bf8d627d7e4be24dd8a3edbac0a9e'
            'c665f694380cb2560822fcf1004950cffaa5880f4f8f17b19a492ff57ffc3c88'
            '028d6d29a893f6a6731f15ad69f99246c62768d91ded8f6632eff115756afdb8'
            '957291699fcfd3d9aea2fa32adc622bc04b3b07301606ee89192e2eff2176662'
            '1e45aca24be1aec09d25a48a3de0fc6b9e6853b46dd29db8c73a63e92d04ea9e'
            'b6669cdce80593e4965a2c241dd92aafb68c01190a00584f08ac6a50158ab106'
            'b935dd8d50a3baf4883854833a2b02a0ab8068efe1a7e3546ded3c712554868f'
            'b84850386d37422c97348feaeed02d84c82f04dc6acc8ffa40c14e0fa015aeef'
            '0b21f6a234c67aa1ab53acb1c2b914ad9e2ff4a0f547d7dcab3280068c4cb2c7'
            '4cb59415bc2d448d2dcdf2c56f9d4612f7d1e9dfe7a8b0044d99b48eb52efbf5'
            'ab08231ec59d1d7d81c430fcaf0c7cbfb7e4f9bb838c0f30cf3e2aea227ebf2a'
            '403cec1455a0c17dd322e69399cbe49944f69e25d0f9791764ddb8cd1d2cbe31'
            'ac21bd2e7a0d366f494a4ed047a455e9646ccc44b4fea032245be7d381bbeb52'
            'a33f566c0e4c16ff77784a689c19b6ca37924ddae7063ce9ae4bbfe00095dcf4'
            'fa9b894e6428de7b574456988bf48a92a6c86a8eac3355bd54e8e0cf12ff8759'
            'e078b61fdade21108fb7025b774ee5373c4e81a20ab67f577bf627ca70438136'
            '42e9e40e468c9e78885435d1697a5c861cbe49702217ed530cd41a7817cf984e'
            '2bc9571d6fdec1daf139f63587dbc9ec1f3f0b40c14d958392a86dbfd454b01b'
            'afab77827c10904355f9a0969b58f4f54391650e3f8b4f950f1255ece91a60d1'
            'f3df07b97057096d7ee2997cd28157c72dbdc1729b89406d05dd3e6ae829457c'
            '55464aeadaaa9f84c7f4a8fb2b53f0875e5ad5c9c983a5e3a233cd40af64f1bc'
            'bd9b2ece20653ad08773c84197fa182a1fefca8ff1acd0d3df08a0ccc19c58b7'
            'fb2c10bf8cbf4ef18d2999062c489f431555664566a53bd278c84fdd8b1d03cc'
            'a5b34703ff13ef4f18feb46bb8e7fc894c5805cc922bce744bdf1db2158cbd85'
            '8de8a15f65e030f40761ab116447f293feea46e729f2c4fb45dcd1a1941f2f02'
            '5d485452f9dafbed4b02322415301cb0ea5a1cb07ce0c06701c09c378665c37c'
            '7b4564a25c7fcaa4f5dad4c8eb86ba426a1825d51d1923ade4ad8be7376217b8'
            '83f108f915863c7ed0338e2d3e8f2e071a531a090ef8f8b2eb3a956a3c4f04d7'
            'd42648cea552ba5353a32e264686e992263289d5cc86207314dffc54ab514981')
