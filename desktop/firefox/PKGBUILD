# Based upon the PKGBUILD from Arch Linux and ebuild from Gentoo
pkgname=firefox
pkgver=11.0
pkgrel=1
pkgdesc="Standalone web browser from mozilla.org (unofficial build)"
arch=('x86_64')
license=('MPL' 'GPL' 'LGPL')
depends=('gtk2' 'mozilla-common' 'nss' 'libxt' 'hunspell' 'startup-notification' 'mime-types'
         'dbus-glib' 'alsa-lib' 'sqlite' 'libnotify' 'desktop-file-utils' 'libvpx' 'libevent'
         'hicolor-icon-theme' 'libffi' 'bzip2' 'zlib' 'nspr' 'libpng' 'libjpeg' 'libidl' 'pixman')
makedepends=('unzip' 'zip' 'yasm' 'mesa' 'autoconf21' 'imake')
url="http://www.mozilla.org/projects/firefox"
source=(ftp://ftp.mozilla.org/pub/mozilla.org/firefox/releases/${pkgver}/source/firefox-${pkgver}.source.tar.bz2)
sha256sums=('2fda6bcfe455c2449a8a69bc16bf13f6ea6006badb0657dae63107e52f051701')

build() {
  cd "${srcdir}/mozilla-release"

  Patch 1001-fix_jemalloc_vs_aslr.patch
  Patch 1002-fix_jemalloc_vs_aslr_part2.patch
  Patch 2003_fix_system_hunspell_dict_detection.patch
  Patch 5000_fix-title-backspace.patch
  Patch 5001_allow_locked_prefs.patch
  Patch 5002_avoid_spurious_run_items_in_application_handlers.patch
  Patch 5003_properly_launch_applications_set_in_home.patch
  Patch 5004_use_yarr_instead_of_pcre_on_unsupported_platforms.patch
  Patch 5005_require_libvpx-1.0.0.patch
  Patch 5007_fix_jemalloc_within_libxul.patch
  Patch 5008_block_opengl_1_drivers_explicitly.patch
  Patch 5009_load_dependent_libraries_with_their_real_path.patch
  Patch 5011_block_nouveau_3d_driver.patch
  Patch 5012_allow_nouveau_driver_with_mesa_8.0.1.patch
  Patch 5013_define_G_VARIANT_TYPE_STRING_ARRAY_for_older_glib.patch
  Patch 5014_revert_621446.patch
  Patch 6003_avoid_invalid_conversions.patch
  Patch 6004_fix_alsa_webm_support.patch
  Patch 6005_only_build_sps_on_supported_platforms.patch
  Patch firefox-install-dir.patch

  sed -i -e "s:gnomevfs::" browser/confvars.sh \
         -e "s:gnomevfs::" xulrunner/confvars.sh

  libtoolize -n --install
  autoconf-2.13
  patch -p0 --no-backup-if-mismatch ipc/chromium/src/third_party/libevent/ltmain.sh "${srcdir}/as-needed_1_5_26.patch"
  patch -p0 --no-backup-if-mismatch modules/freetype2/builds/unix/ltmain.sh "${srcdir}/as-needed_2_2_6.patch"

  cp "${srcdir}/mozconfig" .mozconfig

  # Fix PRE_RELEASE_SUFFIX
  sed -i '/^PRE_RELEASE_SUFFIX := ""/s/ ""//' \
      browser/base/Makefile.in

  export LDFLAGS="${LDFLAGS} -Wl,-rpath,/usr/lib/firefox"
  echo 'LDFLAGS += -lX11 -lXrender' >> layout/build/Makefile.in

  export CXX="/usr/bin/x86_64-pc-linux-gnu-g++"
  export CC="/usr/bin/x86_64-pc-linux-gnu-gcc"

  make -j1 -f client.mk MOZ_MAKE_FLAGS="$MAKEFLAGS"
}

package() {
  cd "${srcdir}/mozilla-release"
  make -j1 -f client.mk DESTDIR="${pkgdir}" install

  install -m644 "${srcdir}"/vendor.js "${pkgdir}/usr/lib/firefox/defaults/pref"

  for i in 16 32 48; do
      install -Dm644 browser/branding/aurora/default${i}.png \
        "${pkgdir}/usr/share/icons/hicolor/${i}x${i}/apps/aurora.png"
  done

  install -Dm644 browser/branding/aurora/mozicon128.png \
    "${pkgdir}/usr/share/icons/hicolor/128x128/apps/aurora.png"

  install -Dm644 browser/branding/aurora/content/icon48.png \
    "${pkgdir}/usr/share/pixmaps/aurora.png"

  rm -rf "$pkgdir"/usr/lib/firefox/{dictionaries,hyphenation}
  ln -sf /usr/share/hunspell "$pkgdir/usr/lib/firefox/dictionaries"
  ln -sf /usr/share/hyphen "$pkgdir/usr/lib/firefox/hyphenation"

  # We don't want the development stuff
  rm -r "${pkgdir}"/usr/{include,lib/firefox-devel,share/idl}

  #workaround for now
  #https://bugzilla.mozilla.org/show_bug.cgi?id=658850
  ln -sf firefox "${pkgdir}/usr/lib/firefox/firefox-bin"
}

source=(${source[@]-}
        1001-fix_jemalloc_vs_aslr.patch
        1002-fix_jemalloc_vs_aslr_part2.patch
        2003_fix_system_hunspell_dict_detection.patch
        5000_fix-title-backspace.patch
        5001_allow_locked_prefs.patch
        5002_avoid_spurious_run_items_in_application_handlers.patch
        5003_properly_launch_applications_set_in_home.patch
        5004_use_yarr_instead_of_pcre_on_unsupported_platforms.patch
        5005_require_libvpx-1.0.0.patch
        5007_fix_jemalloc_within_libxul.patch
        5008_block_opengl_1_drivers_explicitly.patch
        5009_load_dependent_libraries_with_their_real_path.patch
        5011_block_nouveau_3d_driver.patch
        5012_allow_nouveau_driver_with_mesa_8.0.1.patch
        5013_define_G_VARIANT_TYPE_STRING_ARRAY_for_older_glib.patch
        5014_revert_621446.patch
        6003_avoid_invalid_conversions.patch
        6004_fix_alsa_webm_support.patch
        6005_only_build_sps_on_supported_platforms.patch
        as-needed_1_5_26.patch
        as-needed_2_2_6.patch
        firefox-install-dir.patch
        mozconfig
        vendor.js)

sha256sums=(${sha256sums[@]-}
            '08e2d2db0964c86026ecf7ea9cf6473dfb6b0b55fe1d1cee7a5f308daf91acef'
            'dfe33ff9cc24a1795bfb0fb0ea35438588accbb43dc7d918c2e9bf13410a2286'
            'abe9fedabbc842a903f8923517457b05d39eb3a97145adc9437ec25e023b9aae'
            '72fb887a845de23ceb6f300415df0182eebfd4d29d46adc9b06d850e5315dc7a'
            'ce0bb27fcb4d6b765d6b32abfaa798feae7a3f49f965b3daa06958c8c1a93b29'
            '6ac4555e74b10666a86dea1d83b713199643b805c7c833f7524bbf46d288eaa1'
            '1a80f6844ac985cef488e20c918a3e619ada9d29410a7f2c00c9b2205067a1c6'
            '84de5791a08a06b307fcb1d4a2bc0b839ec5a910bfede563aa072e6440c64c4c'
            'bb40372c2b738d2f880a65991c98e6213540dff67edb07f4ae2a7b205afe51d6'
            'fc3b00804d59d2d7c3b4811099b7c5f250db51721ddea1bd16ad00e112fa1f09'
            'dee4e068772f7cd33dcfb1a1bc638227edcb4c910c33c59fc256efd8e43286e1'
            'a6e1ba019a88dd8805c6c41add97ed11cb669c79d7e9335f65ba4c295079b545'
            '749361fd1877e4901e57d06bef79bed186bd5af741f11b5ca6702f37a478233a'
            'd5ca9ebdf1f4caefc9d3259fc2933c79fa429ed2e5a3ebe617fa2bfa27ee8755'
            '404a1c7aa3ea775577a054f567205b53995c58e4ae185463802485daee60695f'
            'b9e62e7e16ce46b17fbc07201a8c8c44bd8d1c317dd9dd2d9e305ce2fc700d0d'
            '07d53f1954ee05d4058b86db7e61e1f1a35b4bfd5690d3753bdc4e7238a1a018'
            '569a6503ba754b6053800ae360a81f5dd2971342f1be1103a1ab4fc6092f150b'
            'c8561ff2f494cfb47730a1cfc117e830c8afdbd4c294f085f45e789cc889dd9d'
            '3060597dcc5801273a2c36ad534a4da76518769c80637803048d041873aa1d28'
            '76e379383f80a463201fe864c1e35c3cd4858b71f26c55b3a5dcb2648e383258'
            '3db7fa9de38b21da92eb3fe2923cd23584c526c6174d984ff7a777fb04a1270b'
            '59c1c4d8d86ae82c07ea10f119e7554192173af65ec69fe862b8a62d813e0399'
            '3c7a38c5a7f22ba672f417ce22caf38f0fd478a81e3d534b51a76a879d227f53')
