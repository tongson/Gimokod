# Based upon the PKGBUILD from Arch Linux
pkgname=firefox
pkgver=7.0.1
pkgrel=1
pkgdesc="Standalone web browser from mozilla.org (unofficial build)"
arch=('i686' 'x86_64')
license=('MPL' 'GPL' 'LGPL')
depends=('gtk2' 'mozilla-common' 'nss' 'libxt' 'hunspell' 'startup-notification' 'mime-types'
         'dbus-glib' 'alsa-lib' 'sqlite' 'libnotify' 'desktop-file-utils' 'libvpx' 'libevent'
         'hicolor-icon-theme' 'libffi' 'bzip2' 'zlib' 'nspr' 'libpng' 'libjpeg' 'libidl')
makedepends=('unzip' 'zip' 'pkg-config' 'yasm' 'mesa' 'autoconf21')
url="http://www.mozilla.org/projects/firefox"
install=firefox.install
source=(ftp://ftp.mozilla.org/pub/mozilla.org/firefox/releases/${pkgver}/source/firefox-${pkgver}.source.tar.bz2)
sha256sums=('81ecf63fca67186094d49dd5a6fe7f5dbd143a39f872ad126de38f246334fc04')

build() {
  cd "${srcdir}/mozilla-release"

  patch -Np1 < ../1001-fix_jemalloc_vs_aslr.patch
  patch -Np0 < ../2001-gentoo_no_app_updates.patch
  patch -Np1 < ../5001_fix-title-backspace.patch
  patch -Np1 < ../5002_allow_locked_prefs.patch
  patch -Np1 < ../5003_avoid_spurious_run_items_in_application_handlers.patch
  patch -Np1 < ../5004_properly_launch_applications_set_in_home.patch
  patch -Np1 < ../5005_do_not_call_openunshareddatabse.patch
  patch -Np1 < ../5006_initialize_ns_xp_come_library_file_from_ns.patch
  patch -Np1 < ../5007_allow_to_pass_an_application_directory.patch
  patch -Np1 < ../5008_always_load_gre_defaults_pref.patch
  patch -Np1 < ../5009_provide_ns_app_pre_defaults_dir.patch
  patch -Np1 < ../5010_only_add_-DEANBLE_JIT-1_to_CXXFLAGS.patch
  patch -Np1 < ../5011_build_fix_for_ENABLE_YARR_JIT-0.patch
  patch -Np1 < ../5017_enable_system_ffi.patch
  patch -Np1 < ../5018_enable_system_ffi_part2.patch

  patch -Np1 -i "${srcdir}/mozilla-firefox-1.0-lang.patch"
  patch -Np1 -i "${srcdir}/firefox-version.patch"

  sed -i -e "s:gnomevfs::" browser/confvars.sh \
         -e "s:gnomevfs::" xulrunner/confvars.sh

  libtoolize -n --install
  autoconf-2.13
  patch -p0 --no-backup-if-mismatch ipc/chromium/src/third_party/libevent/ltmain.sh "${srcdir}/as-needed_1_5_26.patch"
  patch -p0 --no-backup-if-mismatch modules/freetype2/builds/unix/ltmain.sh "${srcdir}/as-needed_2_2_6.patch"
  cd js/src
  libtoolize -n --install
  autoconf-2.13
  patch -p0 --no-backup-if-mismatch ctypes/libffi/ltmain.sh "${srcdir}/as-needed_2_2_6.patch"
  cd ../..

  cp "${srcdir}/mozconfig" .mozconfig

  # Fix PRE_RELEASE_SUFFIX
  sed -i '/^PRE_RELEASE_SUFFIX := ""/s/ ""//' \
      browser/base/Makefile.in

  export LDFLAGS="-Wl,-rpath,/usr/lib/firefox-7.0 -Wl,-O1,--sort-common,--hash-style=gnu,--as-needed"

  echo 'LDFLAGS += -lX11 -lXrender' >> layout/build/Makefile.in

  export CXX="/usr/bin/x86_64-pc-linux-gnu-g++"
  export CC="/usr/bin/x86_64-pc-linux-gnu-gcc"

  make -j1 -f client.mk MOZ_MAKE_FLAGS="$MAKEFLAGS"
}

package() {
  cd "${srcdir}/mozilla-release"
  make -j1 -f client.mk DESTDIR="${pkgdir}" install

  for i in 16 32 48; do
      install -Dm644 browser/branding/unofficial/default${i}.png \
        "${pkgdir}/usr/share/icons/hicolor/${i}x${i}/apps/tumucumaque.png"
  done

  install -Dm644 browser/branding/unofficial/mozicon128.png \
    "${pkgdir}/usr/share/icons/hicolor/128x128/apps/tumucumaque.png"

  install -Dm644 browser/branding/unofficial/content/icon48.png \
    "${pkgdir}/usr/share/pixmaps/tumucumaque.png"

  rm -rf "${pkgdir}"/usr/lib/firefox-7.0/{dictionaries,hyphenation}
  ln -sf /usr/share/hunspell "${pkgdir}/usr/lib/firefox-7.0/dictionaries"
  ln -sf /usr/share/hyphen "${pkgdir}/usr/lib/firefox-7.0/hyphenation"

  # We don't want the development stuff
  rm -r "${pkgdir}"/usr/{include,lib/firefox-devel-7.0,share/idl}

  #workaround for now
  #https://bugzilla.mozilla.org/show_bug.cgi?id=658850
  ln -sf /usr/lib/firefox-7.0/firefox-bin "${pkgdir}/usr/lib/firefox-7.0/firefox"
}

source=(${source[@]-}
        1001-fix_jemalloc_vs_aslr.patch
        2001-gentoo_no_app_updates.patch
        5001_fix-title-backspace.patch
        5002_allow_locked_prefs.patch
        5003_avoid_spurious_run_items_in_application_handlers.patch
        5004_properly_launch_applications_set_in_home.patch
        5005_do_not_call_openunshareddatabse.patch
        5006_initialize_ns_xp_come_library_file_from_ns.patch
        5007_allow_to_pass_an_application_directory.patch
        5008_always_load_gre_defaults_pref.patch
        5009_provide_ns_app_pre_defaults_dir.patch
        5010_only_add_-DEANBLE_JIT-1_to_CXXFLAGS.patch
        5011_build_fix_for_ENABLE_YARR_JIT-0.patch
        5017_enable_system_ffi.patch
        5018_enable_system_ffi_part2.patch
        as-needed_1_5_26.patch
        as-needed_2_2_6.patch
        firefox-version.patch
        mozconfig
        mozilla-firefox-1.0-lang.patch)

sha256sums=(${sha256sums[@]-}
            '08e2d2db0964c86026ecf7ea9cf6473dfb6b0b55fe1d1cee7a5f308daf91acef'
            'dc216c4ca8b886ad076d94a28dff9e3edc7936c0b2a308584f75d870f4afd9a1'
            '72fb887a845de23ceb6f300415df0182eebfd4d29d46adc9b06d850e5315dc7a'
            '73cb9cad5e655c71d785cd56265fb4534a0fad88ca4eda5f81ddabc58055dedc'
            '9c015b4d22d45c92dfb46a7edd0ac69b4f5e259d07af0a0743fb184f111c6eb8'
            '0e06da54ff82bf9d87363d3e3cf661d56d35832d2b8fed718aec99f7cdc637c4'
            'eede4bfa7cf6f9608a305fe0d984dd432510df3ac6de58456ec8c0b7f063935a'
            'f3c5de4b1ef2a5eaafe56fefe3fd4ce15bc619f43de6cbb77a5241b9bb92eea2'
            'a360155bf1badade4ab0e65bdd329dd34d05b8020dc1364a9360e3b907c04e57'
            '57d376b12c09b69c8a31510709c51f14023c69aa1e42139f6067d182066d279b'
            '1f3ca530ff708512779f7b0cd4563f09254844ad6e6b44a09f98f7b63f73b8cb'
            'dfdc92b8c596afa706b7597ff18679e42752b3c220820ca30cf2506b375aa7db'
            '81a81cc6e87c2045c09f491eb14ddea4a862fb19ae1989fe5b0f09e225086cef'
            '3cfab44624b68af8e5f95bba264a4b47789e7d1ee45a49b2a87a4d25b8f0d8dc'
            '7ef8882e509a7296ef19316aca31304ef8a993ad875c06c7169923dc820a1126'
            '3060597dcc5801273a2c36ad534a4da76518769c80637803048d041873aa1d28'
            '76e379383f80a463201fe864c1e35c3cd4858b71f26c55b3a5dcb2648e383258'
            '4658a0f0e8502e443d395c4713730f902c2a35897d5fc9144b3b132506d62596'
            'd1efda1fc9f6ce9daac2deb0a73bbca574c4d00e2f4e450cd9fbec793d0603fe'
            '0ca095ff2af57297f615877a7e79ddc84d1a3f62509a8af6ca50aad7a8671f6a')
