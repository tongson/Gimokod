From: Mike Hommey <mh@glandium.org>
Date: Fri, 9 Mar 2012 09:46:25 +0100
Subject: Bug 734335 - Only build SPS on supported platforms

---
 configure.in                              |   31 +++++++++++++++++++++++++---
 toolkit/library/Makefile.in               |    2 +
 toolkit/library/nsStaticXULComponents.cpp |    8 ++++++-
 tools/profiler/Makefile.in                |    8 ++++--
 tools/profiler/sampler.h                  |    6 ++--
 5 files changed, 44 insertions(+), 11 deletions(-)

diff --git a/configure.in b/configure.in
index 696f950..a9872a0 100644
--- a/configure.in
+++ b/configure.in
@@ -2163,10 +2163,33 @@ fi
 dnl ========================================================
 dnl SPS Profiler
 dnl ========================================================
-MOZ_ARG_ENABLE_BOOL(sps,
-[  --enable-sps          Enable sps profiling tool.],
-    MOZ_ENABLE_PROFILER_SPS=1,
-    MOZ_ENABLE_PROFILER_SPS= )
+MOZ_ENABLE_PROFILER_SPS=1
+
+case "${OS_TARGET}" in
+Android)
+    case "${CPU_ARCH}" in
+    x86 | arm) ;;
+    *)
+        MOZ_ENABLE_PROFILER_SPS=
+    esac
+    ;;
+Linux)
+    case "${CPU_ARCH}" in
+    x86 | x86_64) ;;
+    *)
+        MOZ_ENABLE_PROFILER_SPS=
+    esac
+    ;;
+WINNT|Darwin) ;;
+*)
+    MOZ_ENABLE_PROFILER_SPS=
+    ;;
+esac
+
+MOZ_ARG_DISABLE_BOOL(sps,
+[  --disable-sps         Disable sps profiling tool.],
+    MOZ_ENABLE_PROFILER_SPS=,
+    MOZ_ENABLE_PROFILER_SPS=1)
 if test -n "$MOZ_ENABLE_PROFILER_SPS"; then
     AC_DEFINE(MOZ_ENABLE_PROFILER_SPS)
 fi
diff --git a/toolkit/library/Makefile.in b/toolkit/library/Makefile.in
index 48e8fb4..91cf573 100644
--- a/toolkit/library/Makefile.in
+++ b/toolkit/library/Makefile.in
@@ -316,7 +316,9 @@ endif
 
 STATIC_LIBS += thebes gl ycbcr
 
+ifdef MOZ_ENABLE_PROFILER_SPS
 COMPONENT_LIBS += profiler
+endif
 
 ifeq (windows,$(MOZ_WIDGET_TOOLKIT))
 COMPONENT_LIBS += gkwidget
diff --git a/toolkit/library/nsStaticXULComponents.cpp b/toolkit/library/nsStaticXULComponents.cpp
index 8a668b0..23a6489 100644
--- a/toolkit/library/nsStaticXULComponents.cpp
+++ b/toolkit/library/nsStaticXULComponents.cpp
@@ -205,6 +205,12 @@
 #endif
 #endif
 
+#if defined(MOZ_ENABLE_PROFILER_SPS)
+#define PROFILER_MODULE MODULE(nsProfilerModule)
+#else
+#define PROFILER_MODULE
+#endif
+
 #define XUL_MODULES                          \
     MODULE(nsUConvModule)                    \
     MODULE(nsI18nModule)                     \
@@ -221,7 +227,7 @@
     MODULE(nsWindowDataSourceModule)         \
     MODULE(nsParserModule)                   \
     MODULE(nsGfxModule)                      \
-    MODULE(nsProfilerModule)                 \
+    PROFILER_MODULE                          \
     WIDGET_MODULES                           \
     MODULE(nsImageLib2Module)                \
     ICON_MODULE                              \
diff --git a/tools/profiler/Makefile.in b/tools/profiler/Makefile.in
index 9b43099..414ba5a 100644
--- a/tools/profiler/Makefile.in
+++ b/tools/profiler/Makefile.in
@@ -48,8 +48,10 @@ VPATH       = \
 
 include $(DEPTH)/config/autoconf.mk
 
-EXPORTS = \
-  sampler.h \
+EXPORTS =  sampler.h
+
+ifdef MOZ_ENABLE_PROFILER_SPS
+EXPORTS += \
   sps_sampler.h \
   thread_helper.h \
   $(NULL)
@@ -107,7 +109,7 @@ CPPSRCS += \
   $(NULL)
 endif
 
-
+endif
 
 include $(topsrcdir)/config/rules.mk
 
diff --git a/tools/profiler/sampler.h b/tools/profiler/sampler.h
index e6d5bce..e8603ba 100644
--- a/tools/profiler/sampler.h
+++ b/tools/profiler/sampler.h
@@ -77,6 +77,9 @@
 #ifndef SAMPLER_H
 #define SAMPLER_H
 
+// Redefine the macros for platforms where SPS is supported.
+#ifdef MOZ_ENABLE_PROFILER_SPS
+
 #if defined(_MSC_VER)
 #define FULLFUNCTION __FUNCSIG__
 #elif (__GNUC__ >= 4)
@@ -85,9 +88,6 @@
 #define FULLFUNCTION __FUNCTION__
 #endif
 
-// Redefine the macros for platforms where SPS is supported.
-#if defined(ANDROID) || defined(XP_LINUX) || defined(XP_MACOSX) || defined(XP_WIN)
-
 #include "sps_sampler.h"
 
 #else
