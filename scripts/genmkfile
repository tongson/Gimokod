#!/usr/bin/env lua
-- debug.traceback = nil
PkgbuildRepo = "/home/abs/build"
DistroRepo = "/home/abs/gimokod"
OutputDir = "/home/abs/packages"
BuildDir = "/home/abs/builddir"
pwd = os.getenv("PWD")
concat = function (_) return table.concat(_, " ") end
getpkgbuild = function (_) return PkgbuildRepo.."/"..stripl(pwd).."/".._.."/PKGBUILD" end

function stripl(param)                        -- STRING
    for f in string.gmatch(param, "[^%/%c]+") do
        output = f
    end
    return output
end

function getpopen(cmd)                        -- TABLE
    local _, f = pcall(io.popen, cmd, 'r')
    local out = {}
    for lines in string.gmatch(f:read('*all'), "[%C]+") do
        out[#out+1] = lines
    end
    f:close()
    return out
end

function isdir(param)                         -- BOOLEAN
    local p, f = pcall(io.open, param, 'r')
    if f == nil then return false end
    local ok, error, code = f:read(1)
    f:close()
    if code == 21 then return true end
    return false
end

function isfile(param)                        -- BOOLEAN
    local p, f = pcall(io.open, param, 'r')
    if f == nil then return false end
    local ok, error, code = f:read(1)
    f:close()
    if code == nil then return true end
    return false
end

function table.contains(table, element)       -- BOOLEAN
    for _, value in pairs(table) do
        if value == element then
            return true
        end
    end
    return false
end

function getpkgbin(param)                     -- STRING
    local dir = DistroRepo.."/"..stripl(pwd).."/"
    local cmd = "echo "..dir..param.."-*-*-*.pkg.tar.??"
    local pkgname = string.gsub(param, "-", "%%-")
    local pattern = pkgname.."%-[%a%d%_%.]+%-[%d]+%-[%a%d%_]+%.pkg%.tar%.%w+"
    for _, line in pairs(getpopen(cmd)) do
        for p in string.gmatch(line, "[^%c%z%s]+") do
            if string.find(stripl(p), pattern) then
                pkgbin = stripl(p)
                if isfile(dir..pkgbin) then
                    return pkgbin
                else
                    return false
                end
            end
        end
    end
end

function getdepends(param)                    -- TABLE
    local f = io.input(getpkgbuild(param))
    local pkgbuild = io.read('*all')
    f:close()
    local rdep = {}
    local cdep = {}
    local targets = {"depends", "makedepends"}
    local fulldepends = {}
    rdep["device-mapper"]           = "lvm2"
    rdep["gcc-libs"]                = "gcc"
    rdep["boost-libs"]              = "boost"
    rdep["libltdl"]                 = "libtool"
    rdep["libjpeg"]                 = "libjpeg-turbo"
    rdep["libgl"]                   = "mesa"
    rdep["libglapi"]                = "mesa"
    rdep["libegl"]                  = "mesa"
    rdep["ati-dri"]                 = "mesa"
    rdep["intel-dri"]               = "mesa"
    rdep["nouveau-dri"]             = "mesa"
    rdep["khrplatform-devel"]       = "mesa"
    rdep["xorg-server-xvfb"]        = "xorg-server"
    rdep["xorg-server-common"]      = "xorg-server"
    rdep["xorg-server-devel"]       = "xorg-server"
    rdep["poppler-glib"]            = "poppler"
    rdep["gtk-update-icon-cache"]   = "gtk2"
    cdep["gmp"]                     = "gcc"
    for _, y in ipairs(targets) do
        if string.find(pkgbuild, y) then
            for x in string.gmatch(string.match(pkgbuild, y.."=%b()"), "'([%w%-%_]*[%=%'%<%>]-)'" ) do
                pattern = string.gsub(x, "-", "%%-")
                if table.contains(rdep, rdep[x]) then
                    x = string.gsub(x, pattern, rdep[x])
                end
                if not table.contains(fulldepends, x) and x ~= param and x ~= cdep[param] then
                    fulldepends[#fulldepends+1] = x
                end
            end
        end
    end
    return fulldepends
end

function getpkgnames(param)                   -- TABLE
    local f = io.input(getpkgbuild(param))
    local pkgbuild=io.read('*all')
    local pkgnames = {}
    f:close()
    if string.find(pkgbuild, "pkgbase") then
        pkgname = string.match(pkgbuild, "pkgname=%b()")
        for w in string.gmatch(pkgname, "'([%w%-%_]*)'" ) do
            pkgnames[#pkgnames+1] = w
        end
    else
        pkgnames[#pkgnames+1] = string.match(pkgbuild, "pkgname=([%w%-%_]*)")
    end
    return pkgnames
end

function getdep(param)                        -- STRING
    local deps = {}
    for _,dep in pairs(getdepends(param)) do
        if getpkgbin(dep) then
            deps[#deps+1] = dep
        elseif isdir(dep) then
            deps[#deps+1] = dep
        end
    end
    return concat(deps)
end

do
    local printf = function (...) io.write(string.format(...)) end
    local dirs = {}
    local pwd = stripl(pwd)
    local DistroRepo = DistroRepo.."/"..pwd
    for _, d in pairs(getpopen("for i in *;do echo $i;done")) do
        if isdir(d) then
            dirs[#dirs+1] = d
        end
    end
    printf("all:V: %s \n", concat(dirs))

    for _,pkg in pairs(dirs) do
        if getpkgbin(pkg) then
            printf("%s:V: %s/%s %s \n", pkg, DistroRepo, getpkgbin(pkg), getdep(pkg))
            printf("%s/%s: %s \n" , DistroRepo, getpkgbin(pkg), getpkgbuild(pkg))
            printf("        rm -rf %s/* \n", BuildDir)
            printf("        cd %s \n", pkg)
            printf("        /usr/bin/makepkg --nocheck --noconfirm -ci \n")
            for _,oldpkg in pairs(getpkgnames(pkg)) do
                printf("        rm -f %s/%s{,.sig} \n", DistroRepo, getpkgbin(oldpkg))
            end
            for _,newpkg in pairs(getpkgnames(pkg)) do
                printf("        mv %s/%s-*-*-*.pkg.tar.??{,.sig} %s\n", OutputDir, newpkg, DistroRepo)
            end
        else
            printf("%s:V: %s \n", pkg, getdep(pkg))
            printf("        rm -rf %s/* \n", BuildDir)
            printf("        cd %s \n", pkg)
            printf("        /usr/bin/makepkg --nocheck --noconfirm -ci \n")
            for _,newpkg in pairs(getpkgnames(pkg)) do
                printf("        mv %s/%s-*-*-*.pkg.tar.??{,.sig} %s\n", OutputDir, newpkg, DistroRepo)
            end
        end
    end
end


