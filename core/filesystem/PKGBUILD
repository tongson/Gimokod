pkgname=filesystem
pkgver=2012.03
pkgrel=6
pkgdesc='Filesystem hier'
arch=('any')
url='http://gimokod.org'
license=('LGPL3')
groups=('base')
install=filesystem.install

package() {
    cd ${srcdir}

    for d in ld.so.conf.d skel profile.d; do
      install -d -m755 "${pkgdir}"/etc/${d}
    done

    for f in fstab host.conf hosts hostname issue inputrc ld.so.conf locale.conf motd \
    nsswitch.conf securetty shells profile vconsole.conf os-release; do
      install -m0644 "${srcdir}"/${f} "${pkgdir}"/etc/
    done

    install -d -m0710 -o 0 -g 42 "${pkgdir}/etc/tcb"
    install -d -m02710 -o 1 -g 164 "${pkgdir}/etc/tcb/bin"
    install -d -m02710 -o 2 -g 164 "${pkgdir}/etc/tcb/daemon"
    install -d -m02710 -o 8 -g 164 "${pkgdir}/etc/tcb/mail"
    install -d -m02710 -o 14 -g 164 "${pkgdir}/etc/tcb/ftp"
    install -d -m02710 -o 22 -g 164 "${pkgdir}/etc/tcb/sshd"
    install -d -m02710 -o 28 -g 164 "${pkgdir}/etc/tcb/nscd"
    install -d -m02710 -o 33 -g 164 "${pkgdir}/etc/tcb/http"
    install -d -m02710 -o 81 -g 164 "${pkgdir}/etc/tcb/dbus"
    install -d -m02710 -o 99 -g 164 "${pkgdir}/etc/tcb/nobody"
    install -d -m02710 -o 160 -g 164 "${pkgdir}/etc/tcb/crond"
    install -d -m02710 -o 180 -g 164 "${pkgdir}/etc/tcb/klogd"
    install -d -m02710 -o 181 -g 164 "${pkgdir}/etc/tcb/syslogd"
    install -d -m02710 -o 185 -g 164 "${pkgdir}/etc/tcb/ntpd"
    install -d -m02710 -o 188 -g 164 "${pkgdir}/etc/tcb/dhcp"
    install -d -m02710 -o 800 -g 164 "${pkgdir}/etc/tcb/rngd"

    for id in bin daemon mail ftp sshd nscd http dbus nobody crond klogd syslogd ntpd dhcp rngd; do
      echo "${id}:!:-1::::::" > "${pkgdir}/etc/tcb/${id}/shadow"
      chmod 0640 "${pkgdir}/etc/tcb/${id}/shadow"
    done

    chown 1:164 "${pkgdir}/etc/tcb/bin/shadow"
    chown 2:164 "${pkgdir}/etc/tcb/daemon/shadow"
    chown 8:164 "${pkgdir}/etc/tcb/mail/shadow"
    chown 14:164 "${pkgdir}/etc/tcb/ftp/shadow"
    chown 22:164 "${pkgdir}/etc/tcb/sshd/shadow"
    chown 28:164 "${pkgdir}/etc/tcb/nscd/shadow"
    chown 33:164 "${pkgdir}/etc/tcb/http/shadow"
    chown 81:164 "${pkgdir}/etc/tcb/dbus/shadow"
    chown 99:164 "${pkgdir}/etc/tcb/nobody/shadow"
    chown 160:164 "${pkgdir}/etc/tcb/crond/shadow"
    chown 180:164 "${pkgdir}/etc/tcb/klogd/shadow"
    chown 181:164 "${pkgdir}/etc/tcb/syslogd/shadow"
    chown 185:164 "${pkgdir}/etc/tcb/ntpd/shadow"
    chown 188:164 "${pkgdir}/etc/tcb/dhcp/shadow"
    chown 800:164 "${pkgdir}/etc/tcb/rngd/shadow"

    for d in spool local opt lib/misc empty; do
      install -d -m755 "${pkgdir}"/var/${d}
    done

    touch "${pkgdir}"/var/empty/.keep

    for d in bin include lib share/misc src; do
      install -d -m755 "${pkgdir}"/usr/${d}
    done

    for d in $(seq 8); do
      install -d -m755 "${pkgdir}"/usr/share/man/man${d}
    done

    ln -s ../usr/share/zoneinfo/UTC "${pkgdir}/etc/localtime"
    ln -s /proc/self/mounts "${pkgdir}"/etc/mtab
    ln -s /run/.root/var/lock "${pkgdir}"/var/lock
    ln -s /run/.root/var/db "${pkgdir}"/var/db
    ln -s /run/.root/var/state "${pkgdir}"/var/state
    ln -s /run/.root/var/log "${pkgdir}"/var/log
    ln -s /run/.root/var/spool/mail "${pkgdir}"/var/spool/mail
    ln -s /run/.root/var/spool/mail "${pkgdir}"/var/mail
    ln -s /run/.root/etc/resolv.conf "${pkgdir}"/etc/resolv.conf

    install -D -m0644 layout.conf "${pkgdir}"/etc/tmpfiles.d/layout.conf
    install -D -m0644 net "${pkgdir}"/etc/conf.d/net
    install -D -m0644 "${srcdir}/scm_install" "${pkgdir}/usr/share/pacman/scm_install"
    install -D -m0644 "${srcdir}/scm_upgrade" "${pkgdir}/usr/share/pacman/scm_upgrade"
    install -D -m0644 "${srcdir}/ignore-glob" "${pkgdir}/etc/.fossil-settings/ignore-glob"
}
source=(${source[@]-}
        fstab
        host.conf
        hostname
        hosts
        ignore-glob
        inputrc
        issue
        layout.conf
        ld.so.conf
        locale.conf
        motd
        net
        nsswitch.conf
        os-release
        profile
        protocols
        scm_install
        scm_upgrade
        securetty
        services
        shells
        vconsole.conf)

sha256sums=(${sha256sums[@]-}
            '366c663134b0a0c1ce655b8b8774732fab287d7f140c85c460808d448eea0782'
            'f0709706ce9bf46c58358e040d7eaa96994767438bab274ee5239ac19b0b814b'
            'ab014e33cfd4212e76d000310534b7528f0e2a39ee8e78660a0d9cfcdbac4e4b'
            'e3414c188757954ee34da03cf324fc9864b1758dc472cfe36884ce6415bbdbd3'
            '8a7c078afc2e7c516b89fa1e028e69902193cc391bc425206c7dea8865225e57'
            '17d0662466fa27b8a08e101d3cf8725b99d35715f7455f4c8b343752194ee5b9'
            'ad3883d3b55169ae863134331fa044a36094989dfae555bbe79f7fe6818b68b1'
            '413db0af7ebad9c727023c33b593914f04e1e4735d54dce71d8fd7009e8ffba1'
            '27d7ebd402e1b9a20fd3a0663ccc10e1b1feff2d9dfb1ad7dd12bb76cfe0880a'
            '586ae0a486992c367e38ee8e103a92ad2b0baeb3a8b9898f2e4e7e0c63e5c112'
            'e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855'
            'b9c40f13de41eac91fb3f2aabf575bc6e7e42a6e88cc5fdecd4fb373de2113d9'
            'a1e248357083b55d83659ab50f32c94bf1bcf0825470ccb41702dad3cff712c7'
            'ac6f2cbf709ef493c59d64affce7b99f13ac1f740f745c6417f8437b7bec0944'
            '28dc5110bc5cf90d330d5f29c0dc01edba0925cfba89d50eb8b15769b847638b'
            '9b0d54d258b62c437aefe09e9c3e4e9307051b749e680024bc353f0eb92eb486'
            'b444ab0db948fc08af57880a210c903f166a885b46309065d5922f8ef5af4410'
            '53b0628c2e9c7b67951d20723e1f4abc49b8a1fc06ebef82eb402f350aa88c1b'
            '845fec1cf9b279b2d94eb7d49f1c117d3c58c3cafa6ae4dec20ed62b91c9fb67'
            'e96af627f7774e8c87b0de843556a355fea6150c4d64fa4e2ff2c5fd610e7a79'
            '612d1ba19c101dcce254dba0f566a624d42b434e10eeb1feb1e5800f69989e63'
            'e25196fd051a1ce3e2597d20d8d3d5cd77297d03eebd1d68da02e1ae44c3986d')
