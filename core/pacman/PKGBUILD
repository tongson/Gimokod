# Based upon the PKGBUILD from Arch Linux
pkgname=pacman
pkgver=4.0.0
pkgrel=1
pkgdesc="A library-based package manager with dependency support"
arch=('i686' 'x86_64')
url="http://www.archlinux.org/pacman/"
license=('GPL')
groups=('base')
depends=('libarchive' 'gpgme' 'gimokod-keyring')
backup=(etc/pacman.conf etc/makepkg.conf)
install=pacman.install
options=(!libtool)
source=(ftp://ftp.archlinux.org/other/pacman/"${pkgname}"-"${pkgver}".tar.gz)
sha256sums=('c83bbb8d386b492f9d00a6944c8bcaf84a4372a5f1111d3014638af02abed23e')

PKGEXT='.pkg.tar.gz'

build() {
  cd "${srcdir}"/"${pkgname}"-"${pkgver}"
  patch -Np1 -i ../pacman-4.0.0-dload_h.patch
  patch -Np1 -i ../pacman-4.0.0-makepkg.patch
  ./configure --prefix=/usr \
              --build=${CBUILD} \
              --host=${CHOST} \
              --sysconfdir=/etc \
              --localstatedir=/var \
              --disable-doc \
              --disable-nls \
              --with-openssl \
              --without-libcurl \
              --with-gpgme
  make
}

package() {
  cd "${srcdir}"/"${pkgname}"-"${pkgver}"
  make DESTDIR="${pkgdir}" install

  # install Arch specific stuff
  mkdir -p "${pkgdir}"/etc
  case "$CARCH" in
    i686)
      install -m644 "${srcdir}"/pacman.conf "${pkgdir}"/etc/pacman.conf
      mycarch="i686"
      mychost="i686-pc-linux-gnu"
      myflags="-march=i686 "
      ;;
    x86_64)
      install -m644 "${srcdir}"/pacman.conf.x86_64 "${pkgdir}"/etc/pacman.conf
      mycarch="x86_64"
      mychost="x86_64-unknown-linux-gnu"
      myflags="-march=x86-64 "
      ;;
  esac
  install -m644 "${srcdir}"/makepkg.conf "${pkgdir}"/etc/
  # set things correctly in the default conf file
  sed -i "${pkgdir}"/etc/makepkg.conf \
    -e "s|@CARCH[@]|$mycarch|g" \
    -e "s|@CHOST[@]|$mychost|g" \
    -e "s|@CARCHFLAGS[@]|$myflags|g"

  # install completion files
  mkdir -p "${pkgdir}"/etc/bash_completion.d/
  install -m644 contrib/bash_completion "${pkgdir}"/etc/bash_completion.d/pacman
  mkdir -p "${pkgdir}"/usr/share/zsh/site-functions/
  install -m644 contrib/zsh_completion "${pkgdir}"/usr/share/zsh/site-functions/_pacman
}

source=(${source[@]-}
        makepkg.conf
        pacman-4.0.0-dload_h.patch
        pacman-4.0.0-makepkg.patch
        pacman-4.0.0.tar.gz
        pacman.conf
        pacman.conf.x86_64)

sha256sums=(${sha256sums[@]-}
            '049491c1e3749cffb8033f7c757866490af836697fc5ce7bfbeb66596b9b0bc9'
            '8e84d5873b8891cd4fe2b5bdfcb65c6bad4072fa4e488732cc45d12630464def'
            '33b26bf71b41f21edc370a5abe4643f40f294ffb01fa8f44c2f6eb54d553a707'
            'c83bbb8d386b492f9d00a6944c8bcaf84a4372a5f1111d3014638af02abed23e'
            '2f3916158d489f567670bb54de932419244d368fc33b0eefa3587ca8316904f3'
            '17cda5f057d2137427437afe13544ed88c51a52dd8725fbb0bc707c38d786569')
