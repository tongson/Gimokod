# Based upon the PKGBUILD from Arch Linux
pkgbase=systemd
pkgname=('systemd' 'libsystemd')
pkgver=44
pkgrel=1
pkgdesc="Session and Startup manager"
arch=('x86_64')
url="http://www.freedesktop.org/wiki/Software/systemd"
license=('GPL2')
makedepends=('gperf' 'intltool' 'gettext' 'linux-headers' 'dbus-core' 'kbd' 'libcap'
             'cryptsetup' 'udev' 'kmod' 'xz')
groups=('base')
options=('!libtool' '!strip')

build() {
  cd "${srcdir}/${pkgname}-${pkgver}"

  pushd src
  for f in $(grep -lF '/sbin/' *);do
    sed -i 's:\/sbin\/:\/usr\/bin\/:g' $f
  done
  popd
  Patch 0001-util-never-follow-symlinks-in-rm_rf_children.patch
  ./configure --prefix=/usr \
              --build=${CBUILD} \
              --host=${CHOST} \
              --sysconfdir=/etc \
              --with-udevrulesdir=/usr/lib/udev/rules.d \
              --with-pamlibdir=/usr/lib/security \
              --libexecdir=/usr/lib \
              --libdir=/usr/lib \
              --localstatedir=/var \
              --with-rootlibdir=/usr/lib \
              --disable-audit \
              --disable-tcpwrap \
              --enable-libcryptsetup \
              --with-distro=other \
              --with-sysvinit-path="" \
              --with-sysvrcd-path="" \
              --disable-selinux \
              --disable-plymouth \
              --disable-binfmt \
              --disable-gtk \
              --enable-pam \
              --disable-timedated \
              --disable-hostnamed \
              --disable-localed \
              --disable-quotacheck \
              --disable-manpages \
              --disable-nls

  make
}


package_systemd() {
  pkgdesc="systemd and service manager"
  depends=('dbus-core' 'kbd' 'libcap' 'cryptsetup' 'udev' 'kmod' 'xz' 'libsystemd')
  install=systemd.install
  cd "${srcdir}/${pkgname}-${pkgver}"
  make DESTDIR="${pkgdir}" install
  install -dm755 "${pkgdir}/var/lib/systemd"
  printf "d /run/console 755 root root\n" > "${pkgdir}/usr/lib/tmpfiles.d/console.conf"
  chmod 644 "$pkgdir/usr/lib/tmpfiles.d/console.conf"
  pushd "${pkgdir}/usr/lib/systemd/system"
    sed -i 's:/sbin:/usr/bin:g' *.service >/dev/null 2>&1
  popd

  # --disable-manpages
  rm -rf "${pkgdir}/usr/share/man"

  ### split off libsystemd (libs, includes, pkgconfig)
  install -dm755 "$srcdir"/libsystemd/usr/{include,lib/pkgconfig}

  cd "$srcdir"/libsystemd
  mv "$pkgdir/usr/lib"/libsystemd-*.so* usr/lib
  mv "$pkgdir/usr/include/systemd" usr/include
  mv "$pkgdir/usr/lib/pkgconfig"/libsystemd-*.pc usr/lib/pkgconfig
}

package_libsystemd() {
  pkgdesc="systemd client libraries"
  depends=('libcap' 'xz')
  mv "$srcdir/libsystemd"/* "$pkgdir"
}

source=("http://www.freedesktop.org/software/${pkgname}/${pkgname}-${pkgver}.tar.xz"
        0001-util-never-follow-symlinks-in-rm_rf_children.patch)
sha256sums=('7a5aac4b4b8b3a82bf59292f10e43d8f2c2d7039f34e95714f81d8edcb42233c'
            '4bf6f7d0312f07614d2addece6b48f3301bb85de5f27c8b9729e11b1f4d9e36a')


