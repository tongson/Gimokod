# Based upon the PKGBUILD from Arch and ebuild from Gentoo Linux
pkgname=git
pkgver=1.7.9.5
pkgrel=1
pkgdesc="the fast distributed version control system"
arch=('x86_64')
url="http://git-scm.com/"
license=('GPL2')
depends=('zlib')
groups=('base')
source=("http://git-core.googlecode.com/files/git-"${pkgver}".tar.gz"
        "http://git-core.googlecode.com/files/git-manpages-"${pkgver}".tar.gz"
        git-1.7.3.5-optional-cvs.patch)

build() {
  export PYTHON_PATH=""
  cd "${srcdir}"/"${pkgname}"-"${pkgver}"
  Patch git-1.7.3.5-optional-cvs.patch
  sed -i -e '/\/usr\/local/s/BASIC_/#BASIC_/' Makefile
  sed -i -e '/private-Error.pm/s,^,#,' perl/Makefile.PL
  make prefix=/usr gitexecdir=/usr/lib/git-core \
    CFLAGS="$CFLAGS" LDFLAGS="$LDFLAGS" \
    PERL_MM_OPT="" \
    GIT_TEST_OPTS="--no-color" \
    NO_CROSS_DIRECTORY_HARDLINKS=1 \
    NO_EXPAT=YesPlease \
    NO_FINK=YesPlease \
    NO_DARWIN_PORTS=YesPlease \
    INSTALL=install TAR=tar \
    SHELL_PATH=/usr/bin/sh \
    SANE_TOOL_PATH=\
    OLD_ICONV= \
    NO_EXTERNAL_GREP= \
    NO_ICONV=YesPlease \
    NO_TCLTK=YesPlease \
    NO_PERL=YesPlease \
    NO_PYTHON=YesPlease \
    NO_SVN_TESTS=YesPlease \
    THREADED_DELTA_SEARCH=YesPlease \
    NO_CVS=YesPlease \
    BLK_SHA1=YesPlease \
    all
}

check() {
  export PYTHON_PATH=""
  cd "$srcdir/$pkgname-$pkgver"
  local disabled=""
  local tests_cvs="t9200-git-cvsexportcommit.sh \
        t9400-git-cvsserver-server.sh \
        t9401-git-cvsserver-crlf.sh \
        t9600-cvsimport.sh \
        t9601-cvsimport-vendor-branch.sh \
        t9602-cvsimport-branches-tags.sh \
        t9603-cvsimport-patchsets.sh"
  local tests_perl="t5502-quickfetch.sh \
        t5512-ls-remote.sh \
        t5520-pull.sh"
  local tests_nonroot="t0001-init.sh \
        t0004-unwritable.sh \
        t0070-fundamental.sh \
        t1004-read-tree-m-u-wf.sh \
        t3700-add.sh \
        t7300-clean.sh"
  local test_svn="t9100-git-svn-basic.sh \
        t9118-git-svn-funky-branch-names.sh \
        t9120-git-svn-clone-with-percent-escapes.sh"
  disabled="${disabled} ${tests_cvs} ${tests_perl} ${tests_nonroot} ${test_svn}"
  disabled="${disabled} t5000-tar-tree.sh"

  pushd t
  for i in *.sh.DISABLED ; do
    [[ -f "${i}" ]] && mv -f "${i}" "${i%.DISABLED}"
    done
  for i in ${disabled} ; do
    [[ -f "${i}" ]] && mv -f "${i}" "${i}.DISABLED"
  done
  sed -e '/^[[:space:]]*$(MAKE) clean/s,^,#,g' -i Makefile
  make clean
  popd

  local jobs
  jobs=$(expr "$MAKEFLAGS" : '.*\(-j[0-9]*\).*')
  make prefix=/usr gitexecdir=/usr/lib/git-core \
    CFLAGS="$CFLAGS" LDFLAGS="$LDFLAGS" \
    PERL_MM_OPT="" \
    GIT_TEST_OPTS="--no-color" \
    NO_CROSS_DIRECTORY_HARDLINKS=1 \
    NO_EXPAT=YesPlease \
    NO_FINK=YesPlease \
    NO_DARWIN_PORTS=YesPlease \
    INSTALL=install TAR=tar \
    SHELL_PATH=/usr/bin/sh \
    SANE_TOOL_PATH=\
    OLD_ICONV= \
    NO_EXTERNAL_GREP= \
    NO_ICONV=YesPlease \
    NO_TCLTK=YesPlease \
    NO_PERL=YesPlease \
    NO_PYTHON=YesPlease \
    NO_SVN_TESTS=YesPlease \
    THREADED_DELTA_SEARCH=YesPlease \
    NO_CVS=YesPlease \
    BLK_SHA1=YesPlease \
    --keep-going \
    test

  make prefix=/usr gitexecdir=/usr/lib/git-core \
    CFLAGS="$CFLAGS" LDFLAGS="$LDFLAGS" \
    PERL_MM_OPT="" \
    GIT_TEST_OPTS="--no-color" \
    NO_CROSS_DIRECTORY_HARDLINKS=1 \
    NO_EXPAT=YesPlease \
    NO_FINK=YesPlease \
    NO_DARWIN_PORTS=YesPlease \
    INSTALL=install TAR=tar \
    SHELL_PATH=/usr/bin/sh \
    SANE_TOOL_PATH=\
    OLD_ICONV= \
    NO_EXTERNAL_GREP= \
    NO_ICONV=YesPlease \
    NO_TCLTK=YesPlease \
    NO_PERL=YesPlease \
    NO_PYTHON=YesPlease \
    NO_SVN_TESTS=YesPlease \
    THREADED_DELTA_SEARCH=YesPlease \
    NO_CVS=YesPlease \
    aggregate-results
}

package() {
  export PYTHON_PATH=""
  cd "${srcdir}"/"${pkgname}"-"${pkgver}"
  make prefix=/usr gitexecdir=/usr/lib/git-core \
    CFLAGS="$CFLAGS" LDFLAGS="$LDFLAGS" \
    PERL_MM_OPT="" \
    GIT_TEST_OPTS="--no-color" \
    NO_CROSS_DIRECTORY_HARDLINKS=1 \
    NO_EXPAT=YesPlease \
    NO_FINK=YesPlease \
    NO_DARWIN_PORTS=YesPlease \
    INSTALL=install TAR=tar \
    SHELL_PATH=/usr/bin/sh \
    SANE_TOOL_PATH=\
    OLD_ICONV= \
    NO_EXTERNAL_GREP= \
    NO_ICONV=YesPlease \
    NO_TCLTK=YesPlease \
    NO_PERL=YesPlease \
    NO_PYTHON=YesPlease \
    NO_SVN_TESTS=YesPlease \
    THREADED_DELTA_SEARCH=YesPlease \
    NO_CVS=YesPlease \
    BLK_SHA1=YesPlease \
    DESTDIR="${pkgdir}" install

  # more contrib stuff. Nah don't what them for now.
  # cp -a ./contrib "${pkgdir}"/usr/share/git/

  find "${pkgdir}" -name '*.py' -delete

  # how 'bout some manpages? Yes Please.
  for mansect in man1 man5 man7; do
    for manpage in "${srcdir}"/$mansect/*; do
      install -D -m644 $manpage "${pkgdir}"/usr/share/man/$mansect/$(basename $manpage)
    done
  done

  # remove perllocal.pod, .packlist, and empty directories.
  rm -rf "${pkgdir}"/usr/lib/perl5

  rm -f "${pkgdir}"/usr/lib/git-core/git-svn \
        "${pkgdir}"/usr/share/man/man1/git-svn.1*
}

sha1sums=('33f5a5b0b6c8f8addbbec0b042731c44fd79f90c'
          '37a162c22127adc82ce9fb75aacddb6428c565da'
          '58832c8141a0fd3681c6e9c98600526d290aa637')
